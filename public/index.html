<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini CRM ‚Äì WhatsApp</title>
<link rel="stylesheet" href="/styles.css" />
<header class="topbar">
  <!-- Fila 1: botones -->

  <!-- Fila 2: t√≠tulo -->
  <div class="top-title">
    <h1>üìû Mini CRM ‚Äì <span>WhatsApp</span></h1>
  </div>

  <!-- Fila 3: estado + men√∫ -->
  <div class="top-nav">
    <div id="status" class="status">WhatsApp listo ‚úÖ</div>
    <nav class="nav-links">
      <a href="/index.html" class="nav-link active">Inicio</a>
      <a href="/contactos.html" class="nav-link">Contactos Lucas</a>
      <a href="/contactos_erick.html" class="nav-link">Contactos Erick</a>
      <a href="/contactos_sebas.html" class="nav-link">Contactos Sebas</a>
      <a href="/kanban.html" class="nav-link">Kanban</a>
      <a href="/live.html" class="nav-link">Live Chat</a>
    </nav>
  </div>
</header>
<main>
  <!-- Bot√≥n: agregar nuevo contacto -->
  <script>
  (function () {
    const btn = document.createElement('button');
    btn.id = 'btn-new-contact';
    btn.type = 'button';
    btn.textContent = '‚ûï Agregar nuevo contacto';

    const host =
      document.querySelector('[data-actions]') ||
      document.querySelector('#actions') ||
      document.querySelector('#sidebar') ||
      document.querySelector('header');

    if (host) {
      host.prepend(btn);
    } else {
      Object.assign(btn.style, {
        position: 'fixed', left: '16px', bottom: '16px', zIndex: 9999
      });
      document.body.appendChild(btn);
    }

    btn.addEventListener('click', async () => {
      const name = prompt('Nombre del contacto:');
      if (!name) return;
      const number = prompt('N√∫mero (ej: 55XXXXXXXX o 5255XXXXXXXX):');
      if (!number) return;
      const firstMessage = prompt('Primer mensaje (opcional):') || '';

      try {
        const res = await fetch('/api/send-to', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contactId: number, text: firstMessage || 'Hola üëã' })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo crear la conversaci√≥n');

        const chatId = data.chatId;
        const chatName = (data.chat && data.chat.name) || name || chatId;

        try {
          localStorage.setItem('openChatId', chatId);
          localStorage.setItem('openChatName', chatName);
        } catch (_) {}

        window.location.href = `/index.html?chatId=${encodeURIComponent(chatId)}&name=${encodeURIComponent(chatName)}`;
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });
  })();
  </script>

  <!-- Bot√≥n: eliminar/olvidar -->
  <script>
  (function () {
    const delBtn = document.createElement('button');
    delBtn.id = 'btn-del-contact';
    delBtn.type = 'button';
    delBtn.textContent = 'üóëÔ∏è Eliminar contacto';

    const host =
      document.querySelector('[data-actions]') ||
      document.querySelector('#actions') ||
      document.querySelector('#sidebar') ||
      document.querySelector('header');

    if (host) {
      const ref = document.getElementById('btn-new-contact');
      if (ref && ref.parentNode) ref.parentNode.insertBefore(delBtn, ref.nextSibling);
      else host.prepend(delBtn);
    } else {
      Object.assign(delBtn.style, {
        position: 'fixed', left: '16px', bottom: '56px', zIndex: 9999
      });
      document.body.appendChild(delBtn);
    }

    // üî¥ elimina realmente en el server y lo marca como extra√±o para que el bot s√≠ se active despu√©s
    delBtn.addEventListener('click', async () => {
      // primero intentamos tomar el chat activo
      let raw =
        (window.__currentChatId) ||
        (document.querySelector('#chatList .active')?.dataset.chatId) ||
        (localStorage.getItem('openChatId') || '');

      // si no hay activo, preguntamos
      if (!raw) {
        raw = prompt('Escribe el NOMBRE, n√∫mero (55XXXXXXXX o 5255XXXXXXXX) o chatId (@c.us):') || '';
        if (!raw.trim()) return;
      }

      const body = {};
      if (raw.endsWith('@c.us')) body.chatId = raw;
      else if (/^\d+$/.test(raw.replace(/\D+/g, ''))) body.number = raw;
      else body.name = raw;

      if (!confirm('¬øEliminar/olvidar este contacto en el panel y reiniciar trigger del bot?')) return;

      try {
        const res = await fetch('/api/forget-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo eliminar');

        const deletedId = data.chatId || body.chatId || '';
        // borra del DOM
        if (deletedId) {
          const li = document.querySelector(`#chatList [data-chat-id="${deletedId}"]`);
          if (li && li.parentNode) li.parentNode.removeChild(li);
          if (window.__currentChatId === deletedId) {
            window.__currentChatId = '';
            try {
              localStorage.removeItem('openChatId');
              localStorage.removeItem('openChatName');
            } catch (_) {}
            const messages = document.getElementById('messages');
            if (messages) messages.innerHTML = '';
            const composer = document.getElementById('composer');
            if (composer) composer.classList.add('hidden');
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.classList.remove('hidden');
          }
        }

        alert('Contacto olvidado correctamente. Cuando vuelva a escribir, el bot se va a disparar.');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });
  })();
  </script>

  <aside id="sidebar">
    <div class="toolbar">
      <input id="searchChat" type="text" placeholder="üîç Buscar chat o n√∫mero..." />
    </div>
    <ul id="chatList"></ul>
  </aside>

  <section id="conversation">
    <div id="welcome">
      <p>Selecciona un chat para comenzar.</p>
      <div id="qrBox" class="hidden">
        <h3>Escanea este QR para vincular WhatsApp</h3>
        <canvas id="qrCanvas"></canvas>
      </div>
    </div>

    <div id="messages"></div>

    <form id="composer" class="hidden">
      <div class="row">
        <div class="attach-bar">
          <button type="button" id="btn-attach" title="Adjuntar archivos">üìé</button>
          <input id="filePicker" type="file" multiple hidden
            accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <button type="button" id="btn-audio" title="Grabar audio">üéôÔ∏è</button>
          <span id="recStatus" style="margin-left:8px; font-size:12px; color:#64748b;"></span>
        </div>
      </div>

      <div class="assign">
        <span id="assignedTo"></span>
      </div>
      <div class="row">
        <input id="text" type="text" placeholder="Escribe tu respuesta‚Ä¶" />
        <button type="submit">Enviar</button>
      </div>
    </form>
  </section>
</main>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="/app.js"></script>

<script>
(function () {
  function getCurrentChatId() {
    const active = document.querySelector('#chatList .active');
    if (active && active.dataset.chatId) return active.dataset.chatId;
    if (window.__currentChatId) return window.__currentChatId;
    try {
      const url = new URL(window.location.href);
      const qs = url.searchParams.get('chatId');
      if (qs) return qs;
    } catch {}
    try {
      const stored = localStorage.getItem('openChatId');
      if (stored) return stored;
    } catch {}
    return '';
  }

  const btnAttach = document.getElementById('btn-attach');
  const filePicker = document.getElementById('filePicker');
  const btnAudio  = document.getElementById('btn-audio');
  const recStatus = document.getElementById('recStatus');
  const textInput = document.getElementById('text');

  // ---- Adjuntar archivos ----
  if (btnAttach && filePicker) {
    btnAttach.addEventListener('click', () => filePicker.click());
    filePicker.addEventListener('change', async () => {
      const chatId = getCurrentChatId();
      if (!chatId) { alert('Abre primero una conversaci√≥n.'); filePicker.value=''; return; }
      if (!filePicker.files.length) return;

      const fd = new FormData();
      fd.append('chatId', chatId);
      if (textInput && textInput.value.trim()) fd.append('caption', textInput.value.trim());
      for (const f of filePicker.files) fd.append('files', f, f.name);

      try {
        const res = await fetch('/api/send-media', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error enviando adjuntos');
        filePicker.value = '';
      } catch (e) {
        alert('No se pudo enviar: ' + e.message);
      }
    });
  }

  // ----- Grabaci√≥n de audio -----
  let mediaStream = null;
  let mediaRecorder = null;
  let chunks = [];

  async function startRec() {
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      chunks = [];
      mediaRecorder.ondataavailable = (e) => { if (e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = sendAudio;
      mediaRecorder.start();
      btnAudio.textContent = '‚èπÔ∏è';
      recStatus.textContent = 'Grabando‚Ä¶';
    } catch (e) {
      alert('No se puede acceder al micr√≥fono: ' + e.message);
    }
  }

  async function stopRec() {
    try { mediaRecorder && mediaRecorder.stop(); } catch {}
    try { mediaStream && mediaStream.getTracks().forEach(t => t.stop()); } catch {}
    mediaRecorder = null; mediaStream = null;
    btnAudio.textContent = 'üéôÔ∏è';
  }

  async function sendAudio() {
    const chatId = getCurrentChatId();
    if (!chatId) { alert('Abre primero una conversaci√≥n.'); return; }
    recStatus.textContent = 'Procesando‚Ä¶';

    const blob = new Blob(chunks, { type: chunks[0]?.type || 'audio/webm' });
    const fd = new FormData();
    fd.append('chatId', chatId);
    fd.append('audio', blob, (blob.type.includes('ogg') ? 'nota.ogg' : 'grabacion.webm'));

    try {
      const res = await fetch('/api/send-audio', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error enviando audio');
      recStatus.textContent = data.voice ? 'Nota de voz enviada' : 'Audio enviado';
      setTimeout(() => recStatus.textContent = '', 1200);
    } catch (e) {
      recStatus.textContent = '';
      alert('No se pudo enviar el audio: ' + e.message);
    }
  }

  if (btnAudio) {
    btnAudio.addEventListener('click', () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') startRec();
      else stopRec();
    });
  }
})();
</script>

<style>
  .attach-bar { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
  .attach-bar button {
    background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 10px; border-radius:8px; cursor:pointer;
  }
  .attach-bar button:hover { background:#e5e7eb; }
  #btn-live {
    margin-left: 20px;
    background: #2563eb;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  #btn-live:hover { background: #1d4ed8; }
</style>

</body>
</html>
