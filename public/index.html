<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini CRM ‚Äì WhatsApp</title>
<link rel="stylesheet" href="/styles.css" />
</head>
<body>
<header>
  <h1>üìû Mini CRM ‚Äì WhatsApp</h1>
  <div id="status">Conectando‚Ä¶</div>
  <button id="btn-live" onclick="window.location.href='/live.html'">üí¨ Ir al Live Chat</button>
</header>

<main>
  <!-- Bot√≥n existente para agregar nuevo contacto -->
  <script>
  (function () {
    const btn = document.createElement('button');
    btn.id = 'btn-new-contact';
    btn.type = 'button';
    btn.textContent = '‚ûï Agregar nuevo contacto';

    const host =
      document.querySelector('[data-actions]') ||
      document.querySelector('#actions') ||
      document.querySelector('#sidebar') ||
      document.querySelector('header');

    if (host) {
      host.prepend(btn);
    } else {
      Object.assign(btn.style, {
        position: 'fixed', left: '16px', bottom: '16px', zIndex: 9999
      });
      document.body.appendChild(btn);
    }

    btn.addEventListener('click', async () => {
      const name = prompt('Nombre del contacto:');
      if (!name) return;
      const number = prompt('N√∫mero (ej: 55XXXXXXXX o 5255XXXXXXXX):');
      if (!number) return;
      const firstMessage = prompt('Primer mensaje (opcional):') || '';

      try {
        const res = await fetch('/api/new-contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, number, firstMessage })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo crear la conversaci√≥n');

        // abrir la conversaci√≥n reci√©n creada
        const chatId = data.chatId;
        const chatName = (data.chat && data.chat.name) || name || chatId;

        // Sembramos para que app.js la abra seguro
        try {
          localStorage.setItem('openChatId', chatId);
          localStorage.setItem('openChatName', chatName);
        } catch (_) {}

        // Redirige al panel con par√°metros
        window.location.href = `/index.html?chatId=${encodeURIComponent(chatId)}&name=${encodeURIComponent(chatName)}`;

        // Guarda provisionalmente el contacto en la lista local
        try {
          const existing = JSON.parse(localStorage.getItem('tempContacts') || '[]');
          existing.push({ id: chatId, name: chatName, number });
          localStorage.setItem('tempContacts', JSON.stringify(existing));
        } catch (_) {}
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });
  })();
  </script>

  <!-- Bot√≥n eliminar/olvidar (soft-delete) -->
  <script>
  (function () {
    const delBtn = document.createElement('button');
    delBtn.id = 'btn-del-contact';
    delBtn.type = 'button';
    delBtn.textContent = 'üóëÔ∏è Eliminar contacto';

    const host =
      document.querySelector('[data-actions]') ||
      document.querySelector('#actions') ||
      document.querySelector('#sidebar') ||
      document.querySelector('header');

    if (host) {
      const ref = document.getElementById('btn-new-contact');
      if (ref && ref.parentNode) ref.parentNode.insertBefore(delBtn, ref.nextSibling);
      else host.prepend(delBtn);
    } else {
      Object.assign(delBtn.style, {
        position: 'fixed', left: '16px', bottom: '56px', zIndex: 9999
      });
      document.body.appendChild(delBtn);
    }

    delBtn.addEventListener('click', async () => {
      let raw = prompt('Escribe el NOMBRE, n√∫mero (55XXXXXXXX o 5255XXXXXXXX) o chatId (@c.us):');
      if (!raw) {
        // Usa el chat activo si no escribe nada
        raw = (window.__currentChatId || localStorage.getItem('openChatId') || '').trim();
        if (!raw) return alert('No hay chat abierto ni se ingres√≥ un valor.');
      }

      const body = {};
      if (raw.endsWith('@c.us')) body.chatId = raw;
      else if (/^\d+$/.test(raw.replace(/\D+/g, ''))) body.number = raw;
      else body.name = raw;

      if (!confirm('¬øEliminar/olvidar este contacto en el panel y limpiar el trigger del bot?')) return;

      try {
        const res = await fetch('/api/forget-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo eliminar');

        alert('Contacto olvidado correctamente.\nSi ese n√∫mero te vuelve a escribir (y no est√° en tus contactos), el bot se activar√° una √∫nica vez de nuevo.');

        const chatId = data.chatId || body.chatId || '';
        if (chatId) {
          const li = document.querySelector(`#chatList [data-chat-id="${chatId}"]`);
          if (li && li.parentNode) li.parentNode.removeChild(li);
          const messages = document.getElementById('messages');
          if (messages) messages.innerHTML = '';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });
  })();
  </script>

  <aside id="sidebar">
    <div class="toolbar">
      <input id="searchChat" type="text" placeholder="üîç Buscar chat o n√∫mero..." />
    </div>
    <ul id="chatList"></ul>
  </aside>

  <section id="conversation">
    <div id="welcome">
      <p>Selecciona un chat para comenzar.</p>
      <div id="qrBox" class="hidden">
        <h3>Escanea este QR para vincular WhatsApp</h3>
        <canvas id="qrCanvas"></canvas>
      </div>
    </div>

    <div id="messages"></div>

    <form id="composer" class="hidden">
      <div class="row">
        <div class="attach-bar">
          <button type="button" id="btn-attach" title="Adjuntar archivos">üìé</button>
          <input id="filePicker" type="file" multiple hidden
            accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <button type="button" id="btn-audio" title="Grabar audio">üéôÔ∏è</button>
          <span id="recStatus" style="margin-left:8px; font-size:12px; color:#64748b;"></span>
        </div>
      </div>

      <div class="assign">
        <button type="button" id="assignBtn">üë§ Asignarme este chat</button>
        <span id="assignedTo"></span>
      </div>
      <div class="row">
        <input id="text" type="text" placeholder="Escribe tu respuesta‚Ä¶" />
        <button type="submit">Enviar</button>
      </div>
    </form>
  </section>
</main>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="/app.js"></script>
<script>
(function () {
  // === Obtenci√≥n robusta del chat activo ===
  function getCurrentChatId() {
    // 1) Preferir el chat marcado visualmente como activo
    const active = document.querySelector('#chatList .active');
    if (active && active.dataset.chatId) return active.dataset.chatId;

    // 2) Variable global que app.js mantiene al abrir un chat
    if (window.__currentChatId) return window.__currentChatId;

    // 3) URL (?chatId=...)
    try {
      const url = new URL(window.location.href);
      const qs = url.searchParams.get('chatId');
      if (qs) return qs;
    } catch {}

    // 4) Respaldo en localStorage
    try {
      const stored = localStorage.getItem('openChatId');
      if (stored) return stored;
    } catch {}

    return '';
  }

  const btnAttach = document.getElementById('btn-attach');
  const filePicker = document.getElementById('filePicker');
  const btnAudio  = document.getElementById('btn-audio');
  const recStatus = document.getElementById('recStatus');
  const textInput = document.getElementById('text');

  // ----- Adjuntar archivos -----
  if (btnAttach && filePicker) {
    btnAttach.addEventListener('click', () => filePicker.click());

    filePicker.addEventListener('change', async () => {
      const chatId = getCurrentChatId();
      if (!chatId) { alert('Abre primero una conversaci√≥n.'); filePicker.value=''; return; }
      if (!filePicker.files.length) return;

      const fd = new FormData();
      fd.append('chatId', chatId);
      if (textInput && textInput.value.trim()) fd.append('caption', textInput.value.trim());
      for (const f of filePicker.files) fd.append('files', f, f.name);

      try {
        const res = await fetch('/api/send-media', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error enviando adjuntos');
        filePicker.value = ''; // limpia selecci√≥n
      } catch (e) {
        alert('No se pudo enviar: ' + e.message);
      }
    });
  }

  // ----- Grabaci√≥n de audio (toggle iniciar/detener) -----
  let mediaStream = null;
  let mediaRecorder = null;
  let chunks = [];

  async function startRec() {
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(mediaStream);
      chunks = [];
      mediaRecorder.ondataavailable = (e) => { if (e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = sendAudio;
      mediaRecorder.start();
      btnAudio.textContent = '‚èπÔ∏è';
      recStatus.textContent = 'Grabando‚Ä¶';
    } catch (e) {
      alert('No se puede acceder al micr√≥fono: ' + e.message);
    }
  }

  async function stopRec() {
    try { mediaRecorder && mediaRecorder.stop(); } catch {}
    try { mediaStream && mediaStream.getTracks().forEach(t => t.stop()); } catch {}
    mediaRecorder = null; mediaStream = null;
    btnAudio.textContent = 'üéôÔ∏è';
  }

  async function sendAudio() {
    const chatId = getCurrentChatId();
    if (!chatId) { alert('Abre primero una conversaci√≥n.'); return; }
    recStatus.textContent = 'Procesando‚Ä¶';

    const blob = new Blob(chunks, { type: chunks[0]?.type || 'audio/webm' });
    const fd = new FormData();
    fd.append('chatId', chatId);
    fd.append('audio', blob, (blob.type.includes('ogg') ? 'nota.ogg' : 'grabacion.webm'));

    try {
      const res = await fetch('/api/send-audio', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error enviando audio');
      recStatus.textContent = data.voice ? 'Nota de voz enviada' : 'Audio enviado';
      setTimeout(() => recStatus.textContent = '', 1200);
    } catch (e) {
      recStatus.textContent = '';
      alert('No se pudo enviar el audio: ' + e.message);
    }
  }
async function stopRec() {
  if (!mediaRecorder) return;
  mediaRecorder.stop();
  mediaStream.getTracks().forEach(t => t.stop());
  mediaRecorder = null;
  mediaStream = null;
  btnAudio.textContent = 'üéôÔ∏è';
}

async function sendAudio() {
  if (!chunks.length) { alert('No se grab√≥ audio.'); return; }

  const chatId = getCurrentChatId();
  if (!chatId) { alert('Abre primero una conversaci√≥n.'); return; }

  recStatus.textContent = 'Procesando‚Ä¶';

  const blob = new Blob(chunks, { type: 'audio/webm' });
  const fd = new FormData();
  fd.append('chatId', chatId);
  fd.append('audio', blob, 'nota.webm');

  try {
    const res = await fetch('/api/send-audio', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Error enviando audio');
    recStatus.textContent = 'Nota de voz enviada';
  } catch (e) {
    recStatus.textContent = '';
    alert('No se pudo enviar el audio: ' + e.message);
  } finally {
    chunks = [];
    setTimeout(() => recStatus.textContent = '', 1200);
  }
}

  if (btnAudio) {
    btnAudio.addEventListener('click', () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') startRec();
      else stopRec();
    });
  }
})();
</script>

<style>
  .attach-bar { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
  .attach-bar button {
    background:#f3f4f6; border:1px solid #e5e7eb; padding:6px 10px; border-radius:8px; cursor:pointer;
  }
  .attach-bar button:hover { background:#e5e7eb; }
  #btn-live {
    margin-left: 20px;
    background: #2563eb;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  #btn-live:hover { background: #1d4ed8; }
</style>

</body>
</html>